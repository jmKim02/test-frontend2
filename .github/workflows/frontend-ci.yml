name: Frontend CI 1

on: 
  pull_request:
    types: [opened, synchronize]
    branches: [dev, main]

jobs:
  ci: # PR 대상: Full CI (Lint → Build → Test → Artifact)
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Node.js 환경 설정 (캐싱 포함)
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm' # node_modules 캐싱

      # 3. 의존성 설치
      - name: Install dependencies
        run: npm ci 

      # 4. Next.js 빌드 캐시 복원
      - name: Restore Next.js build cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**.[jt]s', 'src/**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      # Phase 1: Lint (점진적 개선 방식 - max warnings를 줄여 나간다.)
      # 외부 라이브러리, 테스트 파일 등은 .eslintrc.js에서 추가 설정
      - name: Run ESLint
        run: npm run lint -- --max-warnings 100 # Next.js 내장 ESLint 설정 사용

      # Phase 2: Build
      - name: Build Next.js application
        run: npm run build

      # Phase 3: Test
      - name: Run unit tests
        run: npm test -- --passWithNoTests
      
      # Phase 4: Artifact Upload
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-${{ github.sha }}
          path: |
            .next/standalone
            .next/static
            public
          retention-days: 90
          compression-level: 6